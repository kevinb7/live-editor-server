<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title>Output</title>
</head>
<body>

<h1>Output</h1>
<a href="{{ logout_url }}">Logout</a><br>
User ID = {{ id }}<br>
Token = {{ token }}<br>
Code = {{ code }}<br>

<textarea id="message"></textarea>
<button id="sendButton">Send</button>

<script type="text/javascript" src="/_ah/channel/jsapi"></script>
<script>
    // "token" will get replaced if we use the jinja2 templating
    var channel = new goog.appengine.Channel('{{ token }}');
    var socket = channel.open();
    socket.onopen = function () {
        console.log("socket: open");
    };
    socket.onmessage = function (e) {
        console.log("socket: message");
        console.log("output said: %o", JSON.parse(e.data));
    };
    socket.onerror = function () {
        console.log("socket: error");
    };
    socket.onclose = function () {
        console.log("socket: close");
    };

    var id = "{{ id }}";
    var role = "{{ role }}";  // could also grab this from the query string

    // TODO: change this POST to include data in the header and use JSON
    var sendMessage = function(path, obj) {

        var xhr = new XMLHttpRequest();   // new HttpRequest instance
        xhr.open("POST", path);
        xhr.setRequestHeader("Content-Type", "application/json;charset=UTF-8");
        xhr.send(JSON.stringify(obj));
    };

    var sendButton = document.getElementById("sendButton");
    var textarea = document.getElementById("message");

    sendButton.addEventListener("click", function () {
        sendMessage("/output", {
            message: textarea.value,
            time: Date.now(),
            role: "output"
        });
    });

</script>
</body>
</html>