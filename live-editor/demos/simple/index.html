<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Live Editor Simple Demo</title>
    <link rel="stylesheet" href="../../build/css/live-editor.core_deps.css"/>
    <link rel="stylesheet" href="../../build/css/live-editor.audio.css"/>
    <link rel="stylesheet" href="../../build/css/live-editor.tooltips.css"/>
    <link rel="stylesheet" href="../../build/css/live-editor.ui.css"/>
    <style>
        body {
            padding: 10px 20px 20px 20px;
        }

        h1 {
            padding: 0;
            margin: 10px 0 10px 0;
        }

        #sample-live-editor {
            padding: 0;
        }

        iframe {
            border: none;
        }

        #saveButton {
            margin-bottom: 5px;
        }
    </style>
    <script>
        var token = "{{ token }}";
    </script>
</head>
<body>
    <div>
        <a href="/programs">Program List</a>
        <a href="{{ logout_url }}" style="float:right;">logout</a>
    </div>
    <h1>{{ title }}</h1>
    <button id="saveButton">Save</button>
    <div id="sample-live-editor"></div>
    <script type="text/javascript" src="/_ah/channel/jsapi"></script>
    <!--<script src="/socket.io/socket.io.js"></script>-->
    <script src="../../build/js/live-editor.core_deps.js"></script>
    <script src="../../build/js/live-editor.editor_ace_deps.js"></script>
    <script src="../../build/js/live-editor.audio.js"></script>
    <script src="../../build/js/live-editor.shared.js"></script>
    <script src="../../build/js/live-editor.tooltips.js"></script>
    <script src="../../build/js/live-editor.ui.js"></script>
    <script src="../../build/js/live-editor.editor_ace.js"></script>

    <script>
        var code = "{{ code }}";
        if (code === "") {
            code = window.localStorage["test-code"] || "rect(10, 10, 100, 100);";
        }
        var dirty = false;

        window.liveEditor = new LiveEditor({
            el: $("#sample-live-editor"),
            code: code,
            width: 400,
            height: 400,
            editorHeight: "80%",
            autoFocus: true,
            workersDir: "../../build/workers/",
            externalsDir: "../../build/external/",
            imagesDir: "../../build/images/",
            execFile: "output.html",
            jshintFile: "../../build/external/jshint/jshint.js"
        });

        liveEditor.editor.on("change", function() {
            dirty = true;
            window.localStorage["test-code"] = liveEditor.editor.text();
        });

        ScratchpadAutosuggest.init(liveEditor.editor.editor);

        var saveButton = document.getElementById("saveButton");
        saveButton.onclick = function (e) {
            var xhr = new XMLHttpRequest();
            xhr.open("POST", "/save", true);
            xhr.setRequestHeader("Content-Type", "application/json;charset=UTF-8");
            xhr.onload = function () {
                if (xhr.status === 200) {
                    console.log("we're good to go");
                } else {
                    console.log("something went wrong");
                }
            };

            var code = liveEditor.editor.editor.getSession().getValue();
            var pid = "{{ pid }}";
            var obj = { code: code, pid: pid };
            console.log(obj);
            xhr.send(JSON.stringify(obj));
        };

        window.addEventListener("beforeunload", function (e) {
            if (dirty) {
                var message = "You've edited your program.  Your changes will be lost if you don't save them";

                (e || window.event).returnValue = message; //Gecko + IE
                return message; //Gecko + Webkit, Safari, Chrome etc.
            }
        });
    </script>
</body>
</html>
